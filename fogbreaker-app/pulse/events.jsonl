name: validate-fogbreaker-pulse

on:
  pull_request:
    branches: ["reset/scaffold"]
    paths:
      - "fogbreaker-app/pulse/**"
      - ".github/workflows/validate-fogbreaker-pulse.yml"
  workflow_dispatch: {}

permissions:
  contents: read
  pull-requests: read

jobs:
  validate-pulse:
    name: Validate Fogbreaker Pulse
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enforce allowed paths (pulse/** only)
        if: ${{ github.event_name == 'pull_request' }}
        shell: bash
        run: |
          set -euo pipefail
          ALLOWED='^fogbreaker-app/pulse/'
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          git fetch --no-tags --prune origin "${BASE_REF}" >/dev/null 2>&1 || true
          BASE_SHA="$(git merge-base HEAD "origin/${BASE_REF}")"
          CHANGED="$(git diff --name-only "${BASE_SHA}"...HEAD || true)"
          BAD=0
          for f in $CHANGED; do
            if ! echo "$f" | grep -Eq "$ALLOWED"; then
              echo "❌ Forbidden change: $f"; BAD=1
            fi
          done
          [ $BAD -eq 0 ] || { echo "Only fogbreaker-app/pulse/** may change."; exit 1; }
          echo "✅ Allowed paths only."

      - name: Validate Top-10 JSON structure
        run: python .github/scripts/validate_top10.py

      - name: Validate events.jsonl (if present)
        run: python .github/scripts/validate_events.py

      - name: Require daily digest if receipts exist
        shell: bash
        run: |
          set -euo pipefail
          if [ -s fogbreaker-app/pulse/events.jsonl ]; then
            ls fogbreaker-app/pulse/ledger/digest-*.json >/dev/null 2>&1 || { echo "❌ No daily digest in pulse/ledger/"; exit 1; }
            echo "✅ digest present"
          else
            echo "No receipts; digest not required."
          fi

      - name: Optional fee-math sanity check
        run: python .github/scripts/fee_math_check.py
